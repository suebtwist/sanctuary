/**
 * GitHub OAuth Service
 *
 * Implements GitHub Device Flow for CLI-friendly authentication
 */

import { createOAuthDeviceAuth } from '@octokit/auth-oauth-device';
import { getConfig } from '../config.js';

export interface DeviceFlowResponse {
  device_code: string;
  user_code: string;
  verification_uri: string;
  expires_in: number;
  interval: number;
}

export interface GitHubUserInfo {
  id: number;
  login: string;
  created_at: string;
  avatar_url: string;
  name: string | null;
}

export interface TokenResponse {
  access_token: string;
  token_type: string;
  scope: string;
}

/**
 * Start GitHub device flow authentication
 */
export async function startDeviceFlow(): Promise<DeviceFlowResponse> {
  const config = getConfig();

  const response = await fetch('https://github.com/login/device/code', {
    method: 'POST',
    headers: {
      'Accept': 'application/json',
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({
      client_id: config.githubClientId,
      scope: 'read:user',
    }),
  });

  if (!response.ok) {
    const error = await response.text();
    throw new Error(`Failed to start device flow: ${error}`);
  }

  return response.json();
}

/**
 * Poll for device flow completion
 */
export async function pollDeviceFlow(
  deviceCode: string,
  interval: number
): Promise<TokenResponse> {
  const config = getConfig();

  // eslint-disable-next-line no-constant-condition
  while (true) {
    await sleep(interval * 1000);

    const response = await fetch('https://github.com/login/oauth/access_token', {
      method: 'POST',
      headers: {
        'Accept': 'application/json',
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        client_id: config.githubClientId,
        device_code: deviceCode,
        grant_type: 'urn:ietf:params:oauth:grant-type:device_code',
      }),
    });

    const data = await response.json();

    if (data.error) {
      switch (data.error) {
        case 'authorization_pending':
          // User hasn't completed auth yet, continue polling
          continue;
        case 'slow_down':
          // Increase interval
          interval += 5;
          continue;
        case 'expired_token':
          throw new Error('Device code expired. Please start over.');
        case 'access_denied':
          throw new Error('User denied authorization.');
        default:
          throw new Error(`OAuth error: ${data.error_description || data.error}`);
      }
    }

    if (data.access_token) {
      return data as TokenResponse;
    }
  }
}

/**
 * Get GitHub user info using access token
 */
export async function getGitHubUser(accessToken: string): Promise<GitHubUserInfo> {
  const response = await fetch('https://api.github.com/user', {
    headers: {
      'Authorization': `Bearer ${accessToken}`,
      'Accept': 'application/vnd.github+json',
      'X-GitHub-Api-Version': '2022-11-28',
    },
  });

  if (!response.ok) {
    const error = await response.text();
    throw new Error(`Failed to get user info: ${error}`);
  }

  return response.json();
}

/**
 * Check if GitHub account is old enough
 */
export function isAccountOldEnough(createdAt: string, minAgeDays: number): boolean {
  const created = new Date(createdAt);
  const now = new Date();
  const ageMs = now.getTime() - created.getTime();
  const ageDays = ageMs / (1000 * 60 * 60 * 24);
  return ageDays >= minAgeDays;
}

/**
 * Complete OAuth flow using device auth
 * This is an alternative implementation using @octokit/auth-oauth-device
 */
export async function authenticateWithDeviceFlow(
  onVerification: (verification: { verification_uri: string; user_code: string }) => void
): Promise<{ token: string; user: GitHubUserInfo }> {
  const config = getConfig();

  const auth = createOAuthDeviceAuth({
    clientType: 'oauth-app',
    clientId: config.githubClientId,
    scopes: ['read:user'],
    onVerification,
  });

  const { token } = await auth({ type: 'oauth' });
  const user = await getGitHubUser(token);

  return { token, user };
}

// Helper
function sleep(ms: number): Promise<void> {
  return new Promise(resolve => setTimeout(resolve, ms));

